"""
Comprehensive Vulnerability Pattern Database
Contains patterns for detecting security vulnerabilities across all supported languages.
Based on OWASP Top 10, CWE, and common vulnerability databases.
"""

# ============================================================================
# VULNERABILITY PATTERNS DATABASE
# Organized by category and language
# Each pattern: 'pattern': ('description', 'severity', 'cwe_id')
# Severity: CRITICAL, HIGH, MEDIUM, LOW
# ============================================================================

VULNERABILITY_PATTERNS = {
    # ========================================================================
    # INJECTION VULNERABILITIES (CWE-78, CWE-89, CWE-94)
    # ========================================================================
    
    # SQL Injection
    'SELECT * FROM': ('Raw SQL query - use parameterized queries', 'HIGH', 'CWE-89'),
    'SELECT ': ('SQL query detected - verify parameterized queries', 'MEDIUM', 'CWE-89'),
    'INSERT INTO': ('SQL INSERT - use parameterized queries', 'MEDIUM', 'CWE-89'),
    'UPDATE ': ('SQL UPDATE - use parameterized queries', 'MEDIUM', 'CWE-89'),
    'DELETE FROM': ('SQL DELETE - use parameterized queries', 'HIGH', 'CWE-89'),
    'DROP TABLE': ('SQL DROP - extremely dangerous if user-controlled', 'CRITICAL', 'CWE-89'),
    'UNION SELECT': ('SQL UNION injection pattern', 'CRITICAL', 'CWE-89'),
    "' OR '1'='1": ('SQL injection payload detected', 'CRITICAL', 'CWE-89'),
    '" OR "1"="1': ('SQL injection payload detected', 'CRITICAL', 'CWE-89'),
    '-- ': ('SQL comment injection', 'HIGH', 'CWE-89'),
    "' + ": ('String concatenation in query - SQL injection risk', 'HIGH', 'CWE-89'),
    '" + ': ('String concatenation - potential injection risk', 'MEDIUM', 'CWE-89'),
    '% + ': ('Format string in query - injection risk', 'MEDIUM', 'CWE-89'),
    '.format(': ('Python format string - potential injection', 'MEDIUM', 'CWE-89'),
    'f"SELECT': ('Python f-string SQL - injection risk', 'HIGH', 'CWE-89'),
    "f'SELECT": ('Python f-string SQL - injection risk', 'HIGH', 'CWE-89'),
    
    # Command Injection
    'os.system': ('Shell command execution - command injection risk', 'CRITICAL', 'CWE-78'),
    'os.popen': ('Shell command execution - command injection risk', 'CRITICAL', 'CWE-78'),
    'subprocess.call': ('Subprocess execution - verify input sanitization', 'HIGH', 'CWE-78'),
    'subprocess.Popen': ('Direct process spawning - verify input sanitization', 'HIGH', 'CWE-78'),
    'subprocess.run': ('Subprocess execution - verify shell=False', 'MEDIUM', 'CWE-78'),
    'shell=True': ('Shell execution enabled - command injection risk', 'CRITICAL', 'CWE-78'),
    'Runtime.getRuntime().exec': ('Java command execution - injection risk', 'CRITICAL', 'CWE-78'),
    'ProcessBuilder': ('Java process execution - verify input sanitization', 'HIGH', 'CWE-78'),
    'exec(': ('Dynamic code/command execution', 'CRITICAL', 'CWE-78'),
    'system(': ('C/PHP system call - command injection risk', 'CRITICAL', 'CWE-78'),
    'popen(': ('Process execution - command injection risk', 'HIGH', 'CWE-78'),
    'passthru': ('PHP passthru - command injection risk', 'CRITICAL', 'CWE-78'),
    'shell_exec': ('PHP shell_exec - command injection risk', 'CRITICAL', 'CWE-78'),
    'backticks': ('Shell execution via backticks', 'CRITICAL', 'CWE-78'),
    
    # Code Injection
    'eval(': ('Dynamic code execution - code injection risk', 'CRITICAL', 'CWE-94'),
    'eval ': ('Dynamic code execution - code injection risk', 'CRITICAL', 'CWE-94'),
    'exec(': ('Dynamic code execution', 'CRITICAL', 'CWE-94'),
    'compile(': ('Dynamic code compilation', 'HIGH', 'CWE-94'),
    'Function(': ('JavaScript Function constructor - code injection', 'CRITICAL', 'CWE-94'),
    'new Function': ('JavaScript dynamic function - code injection', 'CRITICAL', 'CWE-94'),
    'setTimeout(': ('setTimeout with string - potential code injection', 'MEDIUM', 'CWE-94'),
    'setInterval(': ('setInterval with string - potential code injection', 'MEDIUM', 'CWE-94'),
    'preg_replace': ('PHP preg_replace /e - code execution', 'HIGH', 'CWE-94'),
    'assert(': ('PHP assert - code execution risk', 'HIGH', 'CWE-94'),
    'create_function': ('PHP create_function - deprecated, code injection', 'CRITICAL', 'CWE-94'),
    
    # ========================================================================
    # XSS - CROSS-SITE SCRIPTING (CWE-79)
    # ========================================================================
    'innerHTML': ('XSS risk: Use textContent instead', 'HIGH', 'CWE-79'),
    '.innerHTML =': ('Direct HTML injection - XSS risk', 'HIGH', 'CWE-79'),
    'outerHTML': ('XSS risk: Direct HTML manipulation', 'HIGH', 'CWE-79'),
    'document.write': ('XSS risk: document.write with user input', 'HIGH', 'CWE-79'),
    'document.writeln': ('XSS risk: document.writeln', 'HIGH', 'CWE-79'),
    'insertAdjacentHTML': ('XSS risk: insertAdjacentHTML', 'HIGH', 'CWE-79'),
    'dangerouslySetInnerHTML': ('React XSS risk: dangerouslySetInnerHTML', 'HIGH', 'CWE-79'),
    'v-html': ('Vue XSS risk: v-html directive', 'HIGH', 'CWE-79'),
    '[innerHTML]': ('Angular XSS risk: innerHTML binding', 'HIGH', 'CWE-79'),
    'echo': ('PHP output - verify user input is escaped', 'MEDIUM', 'CWE-79'),
    'print(': ('Output function - verify escaping', 'LOW', 'CWE-79'),
    'printf': ('Formatted output - verify escaping', 'LOW', 'CWE-79'),
    'Response.Write': ('.NET output - verify encoding', 'MEDIUM', 'CWE-79'),
    'Markup(': ('Flask Markup - bypasses autoescaping', 'HIGH', 'CWE-79'),
    '|safe': ('Template safe filter - bypasses escaping', 'HIGH', 'CWE-79'),
    'autoescape false': ('Template autoescaping disabled', 'CRITICAL', 'CWE-79'),
    'escape=False': ('Escaping disabled', 'HIGH', 'CWE-79'),
    
    # ========================================================================
    # PATH TRAVERSAL (CWE-22)
    # ========================================================================
    '../': ('Path traversal pattern detected', 'CRITICAL', 'CWE-22'),
    '..\\': ('Windows path traversal pattern', 'CRITICAL', 'CWE-22'),
    'open(': ('File operation - verify path sanitization', 'MEDIUM', 'CWE-22'),
    'file_get_contents': ('PHP file read - verify path sanitization', 'MEDIUM', 'CWE-22'),
    'include(': ('PHP include - local file inclusion risk', 'HIGH', 'CWE-22'),
    'include_once': ('PHP include - local file inclusion risk', 'HIGH', 'CWE-22'),
    'require(': ('PHP require - local file inclusion risk', 'HIGH', 'CWE-22'),
    'require_once': ('PHP require - local file inclusion risk', 'HIGH', 'CWE-22'),
    'fopen(': ('File open - verify path sanitization', 'MEDIUM', 'CWE-22'),
    'readFile': ('Node.js file read - verify path', 'MEDIUM', 'CWE-22'),
    'readFileSync': ('Node.js file read - verify path', 'MEDIUM', 'CWE-22'),
    'fs.read': ('Node.js file read - verify path', 'MEDIUM', 'CWE-22'),
    'Path.Combine': ('.NET path - verify sanitization', 'MEDIUM', 'CWE-22'),
    'new File(': ('Java File - verify path sanitization', 'MEDIUM', 'CWE-22'),
    'FileInputStream': ('Java file input - verify path', 'MEDIUM', 'CWE-22'),
    'request.args.get': ('User input from request - sanitize before file ops', 'MEDIUM', 'CWE-22'),
    '/var/www': ('Hardcoded path - verify no traversal', 'LOW', 'CWE-22'),
    '/etc/passwd': ('Sensitive file path', 'CRITICAL', 'CWE-22'),
    '/etc/shadow': ('Sensitive file path', 'CRITICAL', 'CWE-22'),
    
    # ========================================================================
    # BUFFER OVERFLOW (CWE-120, CWE-122)
    # ========================================================================
    'strcpy': ('Buffer overflow: Use strncpy or strlcpy', 'CRITICAL', 'CWE-120'),
    'strcat': ('Buffer overflow: Use strncat', 'HIGH', 'CWE-120'),
    'sprintf': ('Buffer overflow: Use snprintf', 'HIGH', 'CWE-120'),
    'vsprintf': ('Buffer overflow: Use vsnprintf', 'HIGH', 'CWE-120'),
    'gets': ('CRITICAL: gets() is always unsafe', 'CRITICAL', 'CWE-120'),
    'scanf': ('Buffer overflow with %s - use width specifier', 'HIGH', 'CWE-120'),
    'sscanf': ('Buffer overflow risk - use width specifiers', 'MEDIUM', 'CWE-120'),
    'fscanf': ('Buffer overflow risk - use width specifiers', 'MEDIUM', 'CWE-120'),
    'realpath': ('Path resolution - check buffer size', 'MEDIUM', 'CWE-120'),
    'getwd': ('Deprecated: Use getcwd with size', 'MEDIUM', 'CWE-120'),
    'memcpy': ('Memory copy - verify bounds checking', 'MEDIUM', 'CWE-120'),
    'memmove': ('Memory move - verify bounds checking', 'MEDIUM', 'CWE-120'),
    
    # ========================================================================
    # INSECURE DESERIALIZATION (CWE-502)
    # ========================================================================
    'pickle.loads': ('Insecure deserialization - arbitrary code execution', 'CRITICAL', 'CWE-502'),
    'pickle.load': ('Insecure deserialization risk', 'CRITICAL', 'CWE-502'),
    'cPickle': ('Insecure deserialization risk', 'CRITICAL', 'CWE-502'),
    'yaml.load': ('YAML load without Loader - code execution risk', 'CRITICAL', 'CWE-502'),
    'yaml.unsafe_load': ('Unsafe YAML loading', 'CRITICAL', 'CWE-502'),
    'marshal.loads': ('Insecure deserialization', 'HIGH', 'CWE-502'),
    'shelve.open': ('Shelve uses pickle - insecure', 'HIGH', 'CWE-502'),
    'unserialize': ('PHP unserialize - object injection risk', 'CRITICAL', 'CWE-502'),
    'ObjectInputStream': ('Java deserialization - object injection', 'CRITICAL', 'CWE-502'),
    'readObject': ('Java deserialization - object injection', 'CRITICAL', 'CWE-502'),
    'JSON.parse': ('JSON parsing - verify source', 'LOW', 'CWE-502'),
    'fromJson': ('Deserialization - verify source', 'LOW', 'CWE-502'),
    'Unmarshal': ('Go deserialization - verify source', 'LOW', 'CWE-502'),
    
    # ========================================================================
    # HARDCODED SECRETS (CWE-798)
    # ========================================================================
    'password =': ('Hardcoded password detected', 'CRITICAL', 'CWE-798'),
    'password=': ('Hardcoded password detected', 'CRITICAL', 'CWE-798'),
    'passwd =': ('Hardcoded password detected', 'CRITICAL', 'CWE-798'),
    'secret =': ('Hardcoded secret detected', 'CRITICAL', 'CWE-798'),
    'secret=': ('Hardcoded secret detected', 'CRITICAL', 'CWE-798'),
    'api_key =': ('Hardcoded API key detected', 'CRITICAL', 'CWE-798'),
    'apikey =': ('Hardcoded API key detected', 'CRITICAL', 'CWE-798'),
    'API_KEY =': ('Hardcoded API key detected', 'CRITICAL', 'CWE-798'),
    'token =': ('Hardcoded token detected', 'HIGH', 'CWE-798'),
    'TOKEN =': ('Hardcoded token detected', 'HIGH', 'CWE-798'),
    'private_key': ('Private key in code', 'CRITICAL', 'CWE-798'),
    'PRIVATE_KEY': ('Private key in code', 'CRITICAL', 'CWE-798'),
    'aws_secret': ('AWS secret in code', 'CRITICAL', 'CWE-798'),
    'AWS_SECRET': ('AWS secret in code', 'CRITICAL', 'CWE-798'),
    'BEGIN RSA PRIVATE': ('RSA private key in code', 'CRITICAL', 'CWE-798'),
    'BEGIN PRIVATE KEY': ('Private key in code', 'CRITICAL', 'CWE-798'),
    'BEGIN EC PRIVATE': ('EC private key in code', 'CRITICAL', 'CWE-798'),
    
    # ========================================================================
    # WEAK CRYPTOGRAPHY (CWE-327, CWE-328)
    # ========================================================================
    'MD5': ('Weak hash: MD5 is cryptographically broken', 'HIGH', 'CWE-328'),
    'md5': ('Weak hash: MD5 is cryptographically broken', 'HIGH', 'CWE-328'),
    'SHA1': ('Weak hash: SHA1 is deprecated', 'MEDIUM', 'CWE-328'),
    'sha1': ('Weak hash: SHA1 is deprecated', 'MEDIUM', 'CWE-328'),
    'DES': ('Weak encryption: DES is broken', 'CRITICAL', 'CWE-327'),
    'RC4': ('Weak encryption: RC4 is broken', 'CRITICAL', 'CWE-327'),
    'ECB': ('Weak mode: ECB mode is insecure', 'HIGH', 'CWE-327'),
    'random.random': ('Weak RNG: Use secrets module', 'MEDIUM', 'CWE-330'),
    'Math.random': ('Weak RNG: Not cryptographically secure', 'MEDIUM', 'CWE-330'),
    'rand()': ('Weak RNG: Use secure random', 'MEDIUM', 'CWE-330'),
    'srand': ('Predictable seed for RNG', 'MEDIUM', 'CWE-330'),
    
    # ========================================================================
    # INSECURE NETWORK (CWE-319, CWE-295)
    # ========================================================================
    'http://': ('Insecure HTTP - use HTTPS', 'MEDIUM', 'CWE-319'),
    'verify=False': ('SSL verification disabled', 'CRITICAL', 'CWE-295'),
    'VERIFY_NONE': ('SSL verification disabled', 'CRITICAL', 'CWE-295'),
    'InsecureRequestWarning': ('Insecure requests being made', 'HIGH', 'CWE-295'),
    'disable_warnings': ('Security warnings disabled', 'HIGH', 'CWE-295'),
    'setHostnameVerifier': ('Custom hostname verifier - potential bypass', 'HIGH', 'CWE-295'),
    'TrustAllCerts': ('Trusting all certificates - MitM risk', 'CRITICAL', 'CWE-295'),
    'allowall': ('Allowing all SSL - insecure', 'CRITICAL', 'CWE-295'),
    'NODE_TLS_REJECT_UNAUTHORIZED': ('Node.js TLS bypass', 'CRITICAL', 'CWE-295'),
    'rejectUnauthorized: false': ('TLS verification disabled', 'CRITICAL', 'CWE-295'),
    
    # ========================================================================
    # XXES AND SSRF (CWE-611, CWE-918)
    # ========================================================================
    'XMLParser': ('XML parsing - check for XXE protection', 'MEDIUM', 'CWE-611'),
    'etree.parse': ('XML parsing - verify external entities disabled', 'MEDIUM', 'CWE-611'),
    'etree.fromstring': ('XML parsing - verify external entities disabled', 'MEDIUM', 'CWE-611'),
    'DocumentBuilder': ('Java XML - disable external entities', 'MEDIUM', 'CWE-611'),
    'SAXParser': ('Java SAX - disable external entities', 'MEDIUM', 'CWE-611'),
    'FEATURE_EXTERNAL_GENERAL_ENTITIES': ('XML external entities setting', 'MEDIUM', 'CWE-611'),
    'requests.get': ('HTTP request - potential SSRF if URL from user', 'MEDIUM', 'CWE-918'),
    'urllib.urlopen': ('URL fetch - potential SSRF', 'MEDIUM', 'CWE-918'),
    'curl_exec': ('PHP cURL - potential SSRF', 'MEDIUM', 'CWE-918'),
    'file://': ('File protocol - potential SSRF/LFI', 'HIGH', 'CWE-918'),
    'gopher://': ('Gopher protocol - SSRF attack vector', 'HIGH', 'CWE-918'),
    
    # ========================================================================
    # AUTHENTICATION/SESSION (CWE-287, CWE-384)
    # ========================================================================
    'session.regenerate': ('Session management - verify proper handling', 'LOW', 'CWE-384'),
    'remember_me': ('Remember me - verify secure implementation', 'MEDIUM', 'CWE-384'),
    'setcookie': ('Cookie setting - verify secure flags', 'MEDIUM', 'CWE-614'),
    'httponly': ('HttpOnly flag usage - verify correct', 'LOW', 'CWE-1004'),
    'secure=False': ('Insecure cookie', 'HIGH', 'CWE-614'),
    'SameSite=None': ('Cookie without SameSite protection', 'MEDIUM', 'CWE-1275'),
    'JWT': ('JWT usage - verify secret and algorithm', 'MEDIUM', 'CWE-347'),
    'none': ('JWT none algorithm - dangerous if accepted', 'CRITICAL', 'CWE-347'),
    
    # ========================================================================
    # RACE CONDITIONS (CWE-362, CWE-367)
    # ========================================================================
    'access(': ('TOCTOU race condition - file access', 'MEDIUM', 'CWE-367'),
    'stat(': ('TOCTOU race condition potential', 'LOW', 'CWE-367'),
    'exists(': ('TOCTOU race condition potential', 'LOW', 'CWE-367'),
    'isfile': ('TOCTOU race condition potential', 'LOW', 'CWE-367'),
    
    # ========================================================================
    # LOGGING/INFORMATION DISCLOSURE (CWE-532)
    # ========================================================================
    'print(password': ('Password in logs', 'CRITICAL', 'CWE-532'),
    'console.log': ('Console logging - remove in production', 'LOW', 'CWE-532'),
    'debug=True': ('Debug mode enabled', 'HIGH', 'CWE-215'),
    'DEBUG = True': ('Debug mode enabled', 'HIGH', 'CWE-215'),
    'stack_trace': ('Stack trace exposure', 'MEDIUM', 'CWE-209'),
    'stacktrace': ('Stack trace exposure', 'MEDIUM', 'CWE-209'),
    'printStackTrace': ('Java stack trace exposure', 'MEDIUM', 'CWE-209'),
    
    # ========================================================================
    # DANGEROUS FUNCTIONS BY LANGUAGE
    # ========================================================================
    # PHP
    '$_GET': ('User input from GET - sanitize', 'MEDIUM', 'CWE-20'),
    '$_POST': ('User input from POST - sanitize', 'MEDIUM', 'CWE-20'),
    '$_REQUEST': ('User input - sanitize', 'MEDIUM', 'CWE-20'),
    '$_COOKIE': ('Cookie input - sanitize', 'MEDIUM', 'CWE-20'),
    '$_SERVER': ('Server variable - some are user-controlled', 'LOW', 'CWE-20'),
    'mysql_query': ('Deprecated MySQL - SQL injection risk', 'HIGH', 'CWE-89'),
    'mysqli_query': ('MySQLi query - use prepared statements', 'MEDIUM', 'CWE-89'),
    'extract(': ('PHP extract - variable injection', 'HIGH', 'CWE-621'),
    'parse_str': ('PHP parse_str - variable injection', 'HIGH', 'CWE-621'),
    '$$': ('PHP variable variables - injection risk', 'HIGH', 'CWE-621'),
    
    # Java
    'createStatement': ('SQL injection: Use PreparedStatement', 'HIGH', 'CWE-89'),
    'executeQuery': ('Potential SQL injection', 'MEDIUM', 'CWE-89'),
    'executeUpdate': ('Potential SQL injection', 'MEDIUM', 'CWE-89'),
    'getParameter': ('User input - sanitize before use', 'MEDIUM', 'CWE-20'),
    'getHeader': ('User-controlled header', 'MEDIUM', 'CWE-20'),
    'getCookies': ('Cookie input - sanitize', 'MEDIUM', 'CWE-20'),
    
    # Ruby
    'send(': ('Ruby send - potential code injection', 'HIGH', 'CWE-94'),
    '__send__': ('Ruby send - potential code injection', 'HIGH', 'CWE-94'),
    'instance_eval': ('Ruby eval - code injection', 'CRITICAL', 'CWE-94'),
    'class_eval': ('Ruby eval - code injection', 'CRITICAL', 'CWE-94'),
    'constantize': ('Rails constantize - code injection', 'HIGH', 'CWE-94'),
    'render inline': ('Rails inline render - potential XSS', 'HIGH', 'CWE-79'),
    '.html_safe': ('Rails html_safe - XSS risk', 'HIGH', 'CWE-79'),
    'raw(': ('Rails raw - bypasses escaping', 'HIGH', 'CWE-79'),
    
    # Go
    'Exec(': ('Go exec - command injection risk', 'HIGH', 'CWE-78'),
    'Run(': ('Go run - verify command safety', 'MEDIUM', 'CWE-78'),
    'template.HTML': ('Go template - XSS risk', 'HIGH', 'CWE-79'),
    'template.JS': ('Go template - XSS risk', 'HIGH', 'CWE-79'),
    'template.URL': ('Go template - XSS risk', 'HIGH', 'CWE-79'),
}

def get_vulnerability_patterns():
    """Return all vulnerability patterns."""
    return VULNERABILITY_PATTERNS

def get_patterns_for_category(category: str) -> dict:
    """Get patterns for a specific vulnerability category."""
    categories = {
        'injection': ['CWE-78', 'CWE-89', 'CWE-94'],
        'xss': ['CWE-79'],
        'path_traversal': ['CWE-22'],
        'buffer_overflow': ['CWE-120', 'CWE-122'],
        'deserialization': ['CWE-502'],
        'secrets': ['CWE-798'],
        'crypto': ['CWE-327', 'CWE-328', 'CWE-330'],
        'network': ['CWE-319', 'CWE-295'],
    }
    
    if category not in categories:
        return {}
    
    cwe_ids = categories[category]
    return {k: v for k, v in VULNERABILITY_PATTERNS.items() if v[2] in cwe_ids}


if __name__ == "__main__":
    print(f"Total patterns: {len(VULNERABILITY_PATTERNS)}")
    
    # Count by severity
    severities = {}
    for pattern, (desc, sev, cwe) in VULNERABILITY_PATTERNS.items():
        severities[sev] = severities.get(sev, 0) + 1
    
    print("\nBy severity:")
    for sev, count in sorted(severities.items()):
        print(f"  {sev}: {count}")
